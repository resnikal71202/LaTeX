name: PR Validation

on:
  pull_request:
    branches: ["main"]
  # Allow manual trigger for testing
  workflow_dispatch:

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-validation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Validate Jekyll build
  build-test:
    name: Test Jekyll Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4.2.2

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1 # v1.202.0
        with:
          ruby-version: '3.3.5'
          bundler-cache: true
          cache-version: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5 # v5.0.0

      - name: Build with Jekyll
        run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: Test HTML output
        run: |
          echo "Checking if site was built..."
          if [ ! -d "_site" ]; then
            echo "Error: _site directory not created"
            exit 1
          fi
          if [ ! -f "_site/index.html" ]; then
            echo "Error: index.html not created"
            exit 1
          fi
          echo "Build successful!"

  # Lint markdown files
  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4.2.2

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v17 # v17.0.0
        with:
          globs: |
            **/*.md
            !vendor/**
            !.bundle/**

  # Check for broken links
  link-check:
    name: Check Links
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4.2.2

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1 # v1.202.0
        with:
          ruby-version: '3.3.5'
          bundler-cache: true
          cache-version: 0

      - name: Build site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Check internal links
        uses: lycheeverse/lychee-action@v2 # v2.1.0
        with:
          args: --verbose --no-progress './_site/**/*.html' --base './_site' --offline
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Dependency review for security
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # v4.2.2

      - name: Dependency Review
        uses: actions/dependency-review-action@v4 # v4.4.0
        with:
          fail-on-severity: moderate
